# Forecast Query Builder API - 

An AI-powered Forecast Query Builder Service that converts `natural language financial questions` into safe, deterministic `PostgreSQL SELECT queries` — without ever connecting to a database.


##  Features

- Natural language → SQL query generation
- Session-based multi-turn conversation support
- LLM-assisted intent extraction and normalization
- Deterministic, rule-based SQL generation
- Clarification handling for ambiguous queries
- Category resolution using external mapping file
- What-if scenario support (increase / decrease %)
- Fully compliant with read-only (`SELECT`) constraints

---




##  Design Principles

- **LLM is used only for language understanding**, not business logic
- **All calculations are deterministic**
- **No SQL is generated by the LLM**
- **No database access**
- **No guessing of missing information**

---

##  Architecture

Client
↓
FastAPI (/query)
↓
Session Manager
↓
LLM Reasoning Layer
↓
Deterministic Intent Processor
↓
SQL Query Builder


##  Project Structure

forecast-query-builder/
│
├── app/
│   ├── main.py                # FastAPI entry point
│   │
│   ├── api/
│   │   └── query.py           # /query endpoint
│   │
│   ├── core/
│   │   ├── config.py          # Environment config
│   │   ├── session.py         # Session/context manager
│   │   └── s3_loader.py       # Load category mapping
│   │
│   ├── services/
│   │   ├── llm_client.py   # OpenAI client
│   │   ├── llm_prompt.py      # LLM system prompt
│   │   ├── nlp_service.py     # Intent analysis
│   │   ├── category_resolver.py
│   │   ├── clarification.py  # Clarification rules
│   │   └── sql_builder.py    # SQL generation
│   │
│   ├── utils/
│   │   ├── date_parser.py     # Date logic (month, quarter, FY)
│   │   └── text_normalizer.py  # "twenty" → 20
│   │
│   └── data/
│       └── categories.json    # Category mapping
│
│
├── Dockerfile
├── requirements.txt
└── README.md



---

##  API Endpoint

### `POST /query`

#### Request Body
```json
{
  "sessionId": "abc123",
  "input": "What if operating expenses decrease by 20% next quarter?"
}


# Response (Clarification Required)

{
  "sessionId": "abc123",
  "response_text": "Which specific expense category do you mean?",
  "status": "pending"
}


#  Response (Query Generated)

{
  "sessionId": "abc123",
  "response_text": "This query shows a what-if scenario where operating expenses decrease by 20%, next quarter.",
  "query": "SELECT ...",
  "status": "finished"
}


# Supported Query Types

# Forecast Queries

    `Show revenue forecast for next quarter`

    `Operating income this month`

# Aggregations

    `Total revenue last 2 months`

    `Sum of operating income YTD`

#  What-if Scenarios

    `What if costs increase by 30% next month?`

    `What if new income decreases by 10% this FY?`


# Supported Time Expressions

this month, next month

last N months (numeric or word-based)

this quarter, next quarter

Q1 2026, Q4

YTD, year to date

this year, next year

FY 2025, this FY, next FY